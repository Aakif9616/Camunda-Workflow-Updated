<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidate Onboarding Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css?v=3.0">
</head>
<body>
    <div class="container">
        <div class="form-container">
            <div class="form-header">
                <h1><i class="fas fa-user-plus"></i> Candidate Onboarding Form</h1>
                <p>Please fill in your personal and banking details to complete the onboarding process</p>
                <div class="application-info" id="application-info">
                    <!-- Application info will be loaded here -->
                </div>
            </div>

            <form id="onboarding-form" class="workflow-form">
                <div class="form-section">
                    <h3><i class="fas fa-id-card"></i> Identity Documents</h3>
                    
                    <div class="form-group">
                        <label for="aadharNumber">Aadhar Number *</label>
                        <input type="text" id="aadharNumber" name="aadharNumber" required 
                               pattern="[0-9]{12}" maxlength="12"
                               placeholder="Enter 12-digit Aadhar number">
                        <small>Enter your 12-digit Aadhar number</small>
                    </div>

                    <div class="form-group">
                        <label for="panNumber">PAN Number *</label>
                        <input type="text" id="panNumber" name="panNumber" required 
                               pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" maxlength="10"
                               placeholder="ABCDE1234F" style="text-transform: uppercase;">
                        <small>Enter your 10-character PAN number</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-university"></i> Banking Details</h3>
                    
                    <div class="form-group">
                        <label for="bankName">Bank Name *</label>
                        <input type="text" id="bankName" name="bankName" required 
                               placeholder="Enter your bank name">
                    </div>

                    <div class="form-group">
                        <label for="bankAccountNumber">Bank Account Number *</label>
                        <input type="text" id="bankAccountNumber" name="bankAccountNumber" required 
                               pattern="[0-9]{9,18}" 
                               placeholder="Enter your bank account number">
                        <small>Enter your bank account number (9-18 digits)</small>
                    </div>

                    <div class="form-group">
                        <label for="bankIFSC">Bank IFSC Code *</label>
                        <input type="text" id="bankIFSC" name="bankIFSC" required 
                               pattern="[A-Z]{4}0[A-Z0-9]{6}" maxlength="11"
                               placeholder="ABCD0123456" style="text-transform: uppercase;">
                        <small>Enter your bank's IFSC code</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-phone"></i> Emergency Contact</h3>
                    
                    <div class="form-group">
                        <label for="emergencyContactName">Emergency Contact Name *</label>
                        <input type="text" id="emergencyContactName" name="emergencyContactName" required 
                               placeholder="Enter emergency contact person's name">
                    </div>

                    <div class="form-group">
                        <label for="emergencyContact">Emergency Contact Number *</label>
                        <input type="tel" id="emergencyContact" name="emergencyContact" required 
                               pattern="[0-9]{10}" maxlength="10"
                               placeholder="Enter 10-digit mobile number">
                        <small>Enter 10-digit mobile number</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-home"></i> Address Details</h3>
                    
                    <div class="form-group">
                        <label for="currentAddress">Current Address *</label>
                        <textarea id="currentAddress" name="currentAddress" required rows="3"
                                  placeholder="Enter your current residential address"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="permanentAddress">Permanent Address *</label>
                        <textarea id="permanentAddress" name="permanentAddress" required rows="3"
                                  placeholder="Enter your permanent address"></textarea>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sameAsCurrentAddress" onchange="copyCurrentAddress()">
                            <label for="sameAsCurrentAddress">Same as current address</label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-heartbeat"></i> Medical Information</h3>
                    
                    <div class="form-group">
                        <label for="bloodGroup">Blood Group</label>
                        <select id="bloodGroup" name="bloodGroup">
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Complete Onboarding
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let applicationId = null;

        // Get application ID from URL parameters
        function getApplicationId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('applicationId');
        }

        // Load application information
        async function loadApplicationInfo() {
            applicationId = getApplicationId();
            
            if (!applicationId) {
                showError('No application ID provided');
                return;
            }

            try {
                const response = await fetch(`/api/job-applications/${applicationId}`);
                const result = await response.json();
                
                if (result.data) {
                    displayApplicationInfo(result.data);
                } else {
                    showError('Application not found');
                }
            } catch (error) {
                console.error('Failed to load application info:', error);
                showError('Failed to load application information');
            }
        }

        // Display application information
        function displayApplicationInfo(appData) {
            const infoContainer = document.getElementById('application-info');
            infoContainer.innerHTML = `
                <div class="app-info-card">
                    <h4>Application Details</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Application ID:</strong> ${applicationId}
                        </div>
                        <div class="info-item">
                            <strong>Name:</strong> ${appData.firstName || ''} ${appData.lastName || ''}
                        </div>
                        <div class="info-item">
                            <strong>Email:</strong> ${appData.email || 'N/A'}
                        </div>
                        <div class="info-item">
                            <strong>Position:</strong> ${formatPosition(appData.position)}
                        </div>
                        <div class="info-item">
                            <strong>Joining Date:</strong> ${appData.joiningDate || 'N/A'}
                        </div>
                        <div class="info-item">
                            <strong>Reporting Manager:</strong> ${appData.reportingManager || 'N/A'}
                        </div>
                        <div class="info-item">
                            <strong>Department:</strong> ${appData.department || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Format position
        function formatPosition(position) {
            if (!position) return 'N/A';
            const positions = {
                'software-engineer': 'Software Engineer',
                'senior-software-engineer': 'Senior Software Engineer',
                'tech-lead': 'Tech Lead',
                'product-manager': 'Product Manager'
            };
            return positions[position] || position;
        }

        // Copy current address to permanent address
        function copyCurrentAddress() {
            const checkbox = document.getElementById('sameAsCurrentAddress');
            const currentAddress = document.getElementById('currentAddress').value;
            const permanentAddress = document.getElementById('permanentAddress');
            
            if (checkbox.checked) {
                permanentAddress.value = currentAddress;
                permanentAddress.readOnly = true;
            } else {
                permanentAddress.readOnly = false;
            }
        }

        // Handle form submission
        document.getElementById('onboarding-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!applicationId) {
                showError('No application ID found');
                return;
            }

            const formData = new FormData(this);
            const onboardingData = {};
            
            // Convert FormData to object
            for (let [key, value] of formData.entries()) {
                onboardingData[key] = value.trim();
            }

            // Validate required fields
            const requiredFields = ['aadharNumber', 'panNumber', 'bankName', 'bankAccountNumber', 
                                  'bankIFSC', 'emergencyContactName', 'emergencyContact', 
                                  'currentAddress', 'permanentAddress'];
            
            for (let field of requiredFields) {
                if (!onboardingData[field]) {
                    showError(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                    return;
                }
            }

            // Show loading state
            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                const response = await fetch(`/api/job-applications/${applicationId}/complete-onboarding`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(onboardingData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('Onboarding completed successfully!');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to complete onboarding');
                }

            } catch (error) {
                console.error('Failed to submit onboarding:', error);
                showError('Failed to complete onboarding: ' + error.message);
                
                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });

        // Show error message
        function showError(message) {
            showNotification(message, 'error');
        }

        // Show success message
        function showSuccess(message) {
            showNotification(message, 'success');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#34a853' : '#ea4335'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Go back function
        function goBack() {
            if (confirm('Are you sure you want to go back? Your progress will be lost.')) {
                window.history.back();
            }
        }

        // Load application info on page load
        document.addEventListener('DOMContentLoaded', loadApplicationInfo);

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .app-info-card {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 1.5rem;
                margin-bottom: 2rem;
            }
            
            .app-info-card h4 {
                margin-bottom: 1rem;
                color: #1a73e8;
            }
            
            .info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
            }
            
            .info-item {
                padding: 0.5rem 0;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .info-item:last-child {
                border-bottom: none;
            }
            
            .checkbox-group {
                margin-top: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .checkbox-group input[type="checkbox"] {
                width: auto;
                margin: 0;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>